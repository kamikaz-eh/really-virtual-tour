<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Really Virtual Tour</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <style>
      body { margin: 0; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

      .ui-top { position: fixed; top: 12px; right: 12px; z-index: 9999; display: flex; gap: 10px; }
      .btn {
        border: 0; border-radius: 12px; padding: 10px 12px;
        background: rgba(0,0,0,0.55); color: #fff; font-size: 14px; cursor: pointer;
        backdrop-filter: blur(6px);
      }
      .btn:hover { background: rgba(0,0,0,0.7); }
      .btn-primary { background: rgba(74,163,255,0.85); color: #06111c; }
      .btn-primary:hover { background: rgba(74,163,255,1); }
      .btn-danger { background: rgba(255,90,90,0.85); }
      .btn-danger:hover { background: rgba(255,90,90,1); }

      .dpad {
        position: fixed; left: 12px; bottom: 12px; z-index: 9999;
        display: none;
        gap: 8px;
        background: rgba(0,0,0,0.35);
        padding: 10px;
        border-radius: 16px;
        backdrop-filter: blur(6px);
        user-select: none; -webkit-user-select: none;
        touch-action: none;
      }
      .dpad-grid {
        display: grid;
        grid-template-columns: 54px 54px 54px;
        grid-template-rows: 54px 54px 54px;
        gap: 8px;
      }
      .padbtn {
        width: 54px; height: 54px;
        border-radius: 16px;
        border: 0;
        background: rgba(255,255,255,0.12);
        color: #fff;
        font-size: 20px;
      }
      .padbtn:active { background: rgba(255,255,255,0.22); }

      .modal-backdrop {
        position: fixed; inset: 0; z-index: 10000;
        background: rgba(0,0,0,0.6);
        display: none; align-items: center; justify-content: center;
        padding: 18px;
      }
      .modal {
        width: min(520px, 100%);
        background: #111;
        border-radius: 18px;
        padding: 18px;
        color: #fff;
        box-shadow: 0 12px 50px rgba(0,0,0,0.5);
      }
      .modal h2 { margin: 0 0 10px 0; font-size: 18px; }
      .modal p { margin: 0 0 14px 0; opacity: 0.9; }
      .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    </style>
  </head>

  <body>
    <div class="ui-top">
      <button class="btn" id="enterVrBtn">Enter VR</button>
      <button class="btn btn-primary" id="applyBtn">Apply now</button>
    </div>

    <div class="dpad" id="dpad">
      <div class="dpad-grid">
        <div></div>
        <button class="padbtn" data-move="forward">↑</button>
        <div></div>

        <button class="padbtn" data-move="left">←</button>
        <button class="padbtn" data-move="stop">•</button>
        <button class="padbtn" data-move="right">→</button>

        <div></div>
        <button class="padbtn" data-move="backward">↓</button>
        <div></div>
      </div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>Apply now</h2>
        <p>Did you like the apartment?</p>
        <div class="modal-actions">
          <button class="btn btn-danger" id="noBtn">No</button>
          <button class="btn btn-primary" id="yesBtn">Yes</button>
          <button class="btn" id="closeBtn">Close</button>
        </div>
        <p id="modalMessage" style="margin-top:14px; display:none;"></p>
      </div>
    </div>

    <a-scene
      id="scene"
      background="color: #111"
      renderer="colorManagement: true;"
      vr-mode-ui="enabled: false"
      webxr="optionalFeatures: local-floor, bounded-floor;"
    >
      <a-entity light="type: ambient; intensity: 0.9"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="2 6 3"></a-entity>

      <!-- Model filename updated per your note -->
      <a-entity id="apt" gltf-model="apt1.glb" position="0 0 0" rotation="0 0 0"></a-entity>

      <!-- Player rig:
           - In VR, movement-controls handles thumbstick smooth locomotion.
           - On desktop, we explicitly enable wasd-controls on the camera to guarantee it works.
      -->
      <a-entity id="rig" movement-controls="speed: 1.4; fly: false" position="0 0 0">
        <a-camera
          id="camera"
          position="0 1.35 0"
          look-controls
          wasd-controls="acceleration: 35"
        ></a-camera>

        <a-entity laser-controls="hand: left"></a-entity>
        <a-entity laser-controls="hand: right"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector("#scene");
      const rig = document.querySelector("#rig");
      const cameraEl = document.querySelector("#camera");

      // Enter VR (always visible button)
      document.querySelector("#enterVrBtn").addEventListener("click", () => {
        try {
          sceneEl.enterVR();
        } catch (e) {
          alert("Could not enter VR here. Try in Quest Browser or a WebXR-enabled browser.");
        }
      });

      // --- Mobile D-pad movement (hold to move) ---
      const isTouch = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
      const dpad = document.querySelector("#dpad");
      if (isTouch) dpad.style.display = "block";

      const moveState = { forward:false, backward:false, left:false, right:false };
      const SPEED = 1.3; // m/s on mobile

      function clearMove() {
        moveState.forward = moveState.backward = moveState.left = moveState.right = false;
      }

      function setMoveOnly(dir) {
        clearMove();
        if (dir && moveState.hasOwnProperty(dir)) moveState[dir] = true;
      }

      // Make buttons "press and hold"
      dpad.addEventListener("pointerdown", (e) => {
        const btn = e.target.closest("button[data-move]");
        if (!btn) return;
        const move = btn.getAttribute("data-move");
        e.preventDefault();

        if (move === "stop") {
          clearMove();
          return;
        }
        setMoveOnly(move);
      });

      // Release stops movement
      ["pointerup","pointercancel","pointerleave","pointerout"].forEach(evt => {
        dpad.addEventListener(evt, (e) => { e.preventDefault(); clearMove(); });
      });

      // Super reliable update loop (doesn't depend on A-Frame tick quirks)
      let last = performance.now();
      function loop(now) {
        const dt = Math.min(0.05, (now - last) / 1000);
        last = now;

        if (isTouch) {
          let dx = 0, dz = 0;
          if (moveState.forward) dz -= 1;
          if (moveState.backward) dz += 1;
          if (moveState.left) dx -= 1;
          if (moveState.right) dx += 1;

          if (dx !== 0 || dz !== 0) {
            const len = Math.hypot(dx, dz);
            dx /= len; dz /= len;

            // Move relative to where the camera is looking (yaw only)
            const rot = cameraEl.getAttribute("rotation");
            const yaw = (rot.y || 0) * Math.PI / 180;
            const cos = Math.cos(yaw), sin = Math.sin(yaw);

            const rx = dx * cos - dz * sin;
            const rz = dx * sin + dz * cos;

            const pos = rig.getAttribute("position");
            rig.setAttribute("position", {
              x: pos.x + rx * SPEED * dt,
              y: pos.y,
              z: pos.z + rz * SPEED * dt
            });
          }
        }

        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

      // --- Apply Now modal ---
      const modalBackdrop = document.querySelector("#modalBackdrop");
      const modalMsg = document.querySelector("#modalMessage");

      function openModal() {
        modalMsg.style.display = "none";
        modalMsg.textContent = "";
        modalBackdrop.style.display = "flex";
      }
      function closeModal() { modalBackdrop.style.display = "none"; }

      document.querySelector("#applyBtn").addEventListener("click", openModal);
      document.querySelector("#closeBtn").addEventListener("click", closeModal);

      document.querySelector("#yesBtn").addEventListener("click", () => {
        modalMsg.style.display = "block";
        modalMsg.textContent = "Congratulations, you've been approved!";
      });

      document.querySelector("#noBtn").addEventListener("click", () => {
        modalMsg.style.display = "block";
        modalMsg.textContent = "Good. We don't like you either.";
        setTimeout(closeModal, 1200);
      });

      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) closeModal();
      });

      // Prevent arrow/WASD focus issues: ensure canvas gets focus on click.
      // (Sometimes key events don't reach A-Frame until the canvas is focused.)
      window.addEventListener("click", () => {
        const canvas = sceneEl && sceneEl.canvas;
        if (canvas && canvas.focus) canvas.focus();
      });
    </script>
  </body>
</html>

